<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            text-align: center;
        }

        input[type="number"] {
            padding: 8px;
            font-size: 16px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        #image-container {
            margin-top: 20px;
        }

        img {
            max-width: 100%;
            max-height: 500px;
        }

        .error {
            color: red;
        }
    </style>
</head>

<body>
    <label for="timestamp">Select Date and Time:</label>
    <input type="datetime-local" id="datetime">
    <script>
        const datetimeInput = document.getElementById('datetime');

        // Get the current UTC time
        const now = new Date();

        // Adjust for Pacific Time (UTC-8)
        const pacificTimeOffset = -8; // Pacific Standard Time (PST) offset in hours
        const pacificTime = new Date(now.getTime() + pacificTimeOffset * 60 * 60 * 1000);

        // Use toISOString and extract the datetime-local format
        const pacificTimeString = pacificTime.toISOString().slice(0, 16); // Extract YYYY-MM-DDTHH:mm
        datetimeInput.max = pacificTimeString;
    </script>

    <button onclick="fetchImage()">Fetch Nearest Archived Image</button>

    <p id="error-message" style="color: red; display: none;"></p>

    <div id="image-container" style="text-align: center;">
        <img id="image" style="display: block; margin: 0 auto; display:none;" alt="Image" />
    </div>

    <script>
        async function fetchImage() {
            const datetimeInput = document.getElementById("datetime").value;
            const errorMessage = document.getElementById("error-message");
            const imageContainer = document.getElementById("image-container");
            const image = document.getElementById("image");

            // Clear previous error or image
            errorMessage.style.display = "none";
            image.style.display = "none";

            if (!datetimeInput) {
                errorMessage.textContent = "Please select a valid date and time.";
                errorMessage.style.display = "block";
                return;
            }

            try {
                // Convert the selected date-time to a Unix timestamp (in seconds)
                const date = new Date(datetimeInput);  // Get Date object from the input
                const timestamp = Math.floor(date.getTime() / 1000);  // Convert to Unix timestamp (seconds)

                const apiUrl = `https://server-554112691235.us-central1.run.app/images/nearest?timestamp=${timestamp}`;

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'image/*',  // Ensure the server knows you want an image
                    },
                    mode: 'cors',
                });

                if (!response.ok) {
                    throw new Error("Error fetching image.");
                }

                // If the backend is sending the image as a raw blob:
                const imageBlob = await response.blob();  // Get the image as a blob

                // Create an object URL from the blob and set it as the image source
                const imageUrl = URL.createObjectURL(imageBlob);  // Convert the blob to a URL
                image.src = imageUrl;  // Set the image source to the object URL
                image.style.display = "block";  // Make the image visible
            } catch (error) {
                errorMessage.textContent = `Network error: ${error.message}`;
                errorMessage.style.display = "block";
                console.error(error);
            }
        }

    </script>
</body>

</html>